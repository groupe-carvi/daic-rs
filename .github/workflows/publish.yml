name: Publish to crates.io

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang libclang-dev \
            cmake ninja-build pkg-config \
            python3 \
            autoconf automake autoconf-archive libtool \
            libudev-dev libssl-dev \
            nasm \
            libdw-dev libelf-dev

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Validate tag matches Cargo.toml version
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          python3 - <<'PY'
          import os
          import re
          import tomllib

          ref = os.environ.get('REF_NAME', '')
          m = re.match(r'^v(?P<ver>\d+\.\d+\.\d+.*)$', ref)
          if not m:
            raise SystemExit(f"Tag '{ref}' does not match expected pattern v<semver> (e.g. v0.1.0)")
          tag_ver = m.group('ver')

          with open('Cargo.toml', 'rb') as f:
            root = tomllib.load(f)
          cargo_ver = root.get('workspace', {}).get('package', {}).get('version')
          if not cargo_ver:
            raise SystemExit('Could not read [workspace.package].version from Cargo.toml')

          if cargo_ver != tag_ver:
            raise SystemExit(f"Tag version ({tag_ver}) does not match Cargo.toml workspace version ({cargo_ver})")

          print(f"OK: tag {tag_ver} matches Cargo.toml version")
          PY

      # IMPORTANT:
      # - Set the repository secret CRATES_IO_TOKEN to a crates.io API token.
      # - We publish internal crates first.
      - name: Publish depthai-macros
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p depthai-macros --locked

      - name: Publish depthai-sys
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p depthai-sys --locked

      - name: Publish depthai
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p depthai --locked
