name: Publish to crates.io

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang libclang-dev \
            cmake ninja-build pkg-config \
            python3 \
            autoconf automake autoconf-archive libtool \
            libudev-dev libssl-dev \
            nasm \
            libdw-dev libelf-dev

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Sync Cargo.toml version from tag
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          python3 - <<'PY'
          import os
          import re

          ref = os.environ.get('REF_NAME', '')
          m = re.match(r'^v(?P<ver>\d+\.\d+\.\d+(?:[-+][0-9A-Za-z.-]+)?)$', ref)
          if not m:
            raise SystemExit(
              f"Tag '{ref}' does not match expected pattern v<semver> (e.g. v0.1.0 or v0.1.0-rc.1)"
            )
          tag_ver = m.group('ver')

          cargo_toml_path = 'Cargo.toml'
          with open(cargo_toml_path, 'r', encoding='utf-8') as f:
            text = f.read()

          # Update [workspace.package].version (this drives `version.workspace = true` crates).
          m_sec = re.search(r'(?ms)^\[workspace\.package\]\s*\n(.*?)(?=^\[|\Z)', text)
          if not m_sec:
            raise SystemExit('Could not find [workspace.package] section in Cargo.toml')
          section = m_sec.group(1)

          new_section, n = re.subn(
            r'(?m)^version\s*=\s*"[^"]*"\s*$',
            f'version = "{tag_ver}"',
            section,
            count=1,
          )
          if n != 1:
            raise SystemExit('Could not update [workspace.package].version in Cargo.toml')
          text = text[:m_sec.start(1)] + new_section + text[m_sec.end(1):]

          # Update pinned intra-workspace dependency versions used when publishing.
          def bump_dep_version(t: str, name: str) -> str:
            pat = rf'(?m)^(\s*{re.escape(name)}\s*=\s*\{{[^\n\r]*?\bversion\s*=\s*")([^"]+)("[^\n\r]*\}}\s*)$'
            new_t, nn = re.subn(pat, rf'\g<1>{tag_ver}\g<3>', t, count=1)
            if nn != 1:
              raise SystemExit(f"Could not update dependency version for '{name}' in Cargo.toml")
            return new_t

          text = bump_dep_version(text, 'depthai-sys')
          text = bump_dep_version(text, 'depthai-macros')

          with open(cargo_toml_path, 'w', encoding='utf-8', newline='\n') as f:
            f.write(text)

          print(f"Updated Cargo.toml workspace/dependency versions to {tag_ver} from tag {ref}")
          PY

      - name: Regenerate Cargo.lock
        run: cargo generate-lockfile

      # IMPORTANT:
      # - Set the repository secret CRATES_IO_TOKEN to a crates.io API token.
      # - We publish internal crates first.
      - name: Publish depthai-macros
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p depthai-macros --locked --allow-dirty

      - name: Publish depthai-sys
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p depthai-sys --locked --allow-dirty

      - name: Publish depthai
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p depthai --locked --allow-dirty
